<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="author" content="Thomas Prochazka"/><meta name="description" content="A little Software Engineering Blog by Thomas Prochazka, filled with posts regarding engineering problems and solutions"/><meta name="keywords" content="Software Engineer, Software Development, Blog"/><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><link rel="icon" href="/favicon.ico" type="image/x-icon"/><link rel="alternate" type="application/atom+xml" title="Software Engineering by Thomas Prochazka" href="/feed.xml"/><title>COM Exception with IISNode and node-export-server</title><meta property="og:title" content="COM Exception with IISNode and node-export-server"/><meta property="og:description" content="Find out where these SetProcessDpiAwareness exception in node-export-server are coming from"/><meta property="og:image" content="https://www.gravatar.com/avatar/52a73317cd435a835d6cc927959f988c"/><meta property="og:url" content="https://zlypher.github.io/posts/com-exception-with-iisnode-and-node-export-server"/><meta name="twitter:card" content="summary"/><meta property="og:site_name" content="Software Engineering by Thomas Prochazka"/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/d369737c033aa1b9.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d369737c033aa1b9.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-fd82975a6094609f.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-c586b89e07064d4a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-a73aab26615105d8.js" defer=""></script><script src="/_next/static/chunks/498-434190b3645d9505.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-e1e32c4830a50dd7.js" defer=""></script><script src="/_next/static/_tmxQgfmILsdsozf-wc_b/_buildManifest.js" defer=""></script><script src="/_next/static/_tmxQgfmILsdsozf-wc_b/_ssgManifest.js" defer=""></script><script src="/_next/static/_tmxQgfmILsdsozf-wc_b/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><svg xmlns="http://www.w3.org/2000/svg" style="display:none"><symbol id="icon-linked" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z"></path></symbol><symbol id="icon-github" viewBox="0 0 24 24" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></symbol><symbol id="icon-twitter" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812 0-3.282 1.47-3.282 3.28 0 .26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26 0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04 0 9.34-5 9.34-9.33 0-.14 0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z"></path></symbol><symbol id="icon-facebook" viewBox="0 0 16 16" fill-rule="evenodd"><path d="M10.28 14V9.35h1.56l.23-1.8h-1.79V6.38c0-.53.15-.89.9-.89h.96V3.88c-.17-.02-.74-.07-1.4-.07-1.38 0-2.33.85-2.33 2.4v1.33H6.85v1.81H8.4V14H2.66a.66.66 0 0 1-.66-.66V2.66c0-.36.3-.66.66-.66h10.68c.36 0 .66.3.66.66v10.68c0 .36-.3.66-.66.66h-3.06z"></path></symbol></svg><div class="o-page-wrapper"><nav class="c-menu"><ul class="c-menu__list"><li class="c-menu__list-item"><a class="c-menu__link" href="/">Posts</a></li><li class="c-menu__list-item"><a class="c-menu__link" href="/talks">Talks</a></li><li class="c-menu__list-item"><a class="c-menu__link" href="/about">About Me</a></li></ul></nav><main class="o-main"><article class="c-post" itemscope="" itemType="http://schema.org/BlogPosting"><header class="c-post__header"><time class="c-post__date" dateTime="2018-11-29T11:46:00.000Z" itemProp="datePublished">November 29, 2018</time><h1 class="c-post__title" itemProp="name headline">COM Exception with IISNode and node-export-server</h1></header><div class="c-post__content" itemProp="articleBody"><h2>The Problem</h2>
<p>For our web application, we use Highcharts to render beautiful charts. Some charts are reused multiple times across the website, so we decided to prerender them via <a href="https://github.com/highcharts/node-export-server">highcharts/node-export-server</a>. Due to operational reasons, it is hosted inside a Windows Service via <a href="https://github.com/Azure/iisnode">Azure/iisnode</a>. This process works reasonably well. However, we noticed, that there are errors logged, although the charts seem to be rendered just fine:</p>
<pre><code class="hljs language-go">[<span class="hljs-type">error</span>] phantom worker <span class="hljs-number">2</span> <span class="hljs-type">error</span> - SetProcessDpiAwareness failed: <span class="hljs-string">&quot;COM error 0x80070005  (Unknown error 0x0ffffffff80070005)&quot;</span>
</code></pre>
<h2>Investigation of the Error</h2>
<p>Naturally, we wanted to find the cause of this error, if there are some issues we should be aware of and if there is anything we could do to avoid it.</p>
<p>A quick search reveals, that there are quite some GitHub repositories, that experience similar issues. In the end, most of them refer to an issue in PhantomJS. The most prominent discussion is in the <a href="https://github.com/ariya/phantomjs/issues/14095">issue #14095</a>. If you don&#x27;t know: &quot;PhantomJS (phantomjs.org) is a headless WebKit scriptable with JavaScript.&quot; (from Phantom JS README). Incidentally, it is used by the Highcharts Node.js Export Server to render the charts. And unfortunately, this issue occurs, if PhantomJS is run from a service in Windows. Which happens to be just what we are doing.</p>
<h2>Resolving the Error</h2>
<h3>Pass flag to PhantomJS</h3>
<p>However, there seems to be a way around this issue. According the issue, it is possible to pass <code>-platform windows:dpiawareness=0</code> to PhantomJS. So can we actually configure this, since the phantomjs process is spawned by the node-export-server? The actual call happens in <code>phantompool.js</code>:</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// https://github.com/highcharts/node-export-server/blob/2.0.16/lib/phantompool.js</span>
worker.<span class="hljs-property">process</span> = phantomjs.<span class="hljs-title hljs-function">exec</span>(settings.<span class="hljs-property">worker</span>, (__dirname + <span class="hljs-string">&#x27;/../&#x27;</span>));
</code></pre>
<p>There is no way to configure additional options, so we are out of luck here.</p>
<h3>Windows Registry</h3>
<p>There seems to be some additional way to work around this issue via the Windows Registry or Windows Policies, but I wasn&#x27;t able to find out the specifics. If you have more luck on this front, please let me know.</p>
<h3>Fork node-export-server</h3>
<p>Another possibility would be to fork the node-export-server repository on GitHub and implement the desired functionality. However, this would cause additional overhead and it seems unlikely, that this would be merged back into the main repository. Since it seems that the engineers from Highcharts are thinking about moving to a different headless browser like Chrome (with its rather new headless mode). However, there doesn&#x27;t seem to be a clear path or timeline yet. Follow the <a href="https://github.com/highcharts/node-export-server/issues/57">issue #57 on GitHub</a> for further updates.</p>
<h2>Result</h2>
<p>In the end, we decided to live with these errors for now, as there doesn&#x27;t seem to be any problem with the chart generation itself. Workarounds would require further development and testing resources which are currently not available.</p>
<p><strong>Resources</strong></p>
<ul>
<li><a href="https://github.com/highcharts/node-export-server">node-export-server Repository</a></li>
<li><a href="https://github.com/Azure/iisnode">iisnode Repository</a></li>
<li><a href="https://github.com/ariya/phantomjs">PhantomJS Repository</a></li>
</ul></div><footer><div class="c-post__share"><a class="c-post__share-link" target="blank" href="https://twitter.com/intent/tweet?text=COM%20Exception%20with%20IISNode%20and%20node-export-server%20https://zlypher.github.io/posts/com-exception-with-iisnode-and-node-export-server"><span class="u-sr-only">Share via Twitter</span><svg class="c-post__share-icon"><use xlink:href="#icon-twitter"></use></svg></a><a class="c-post__share-link" target="blank" href="http://www.facebook.com/sharer/sharer.php?u=https://zlypher.github.io/posts/com-exception-with-iisnode-and-node-export-server&amp;title=COM%20Exception%20with%20IISNode%20and%20node-export-server"><span class="u-sr-only">Share via Facebook</span><svg class="c-post__share-icon"><use xlink:href="#icon-facebook"></use></svg></a></div><p class="c-post__info">Please let me know if you have any suggestions or corrections to improve this post. Feedback is always appreciated.</p></footer></article></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"layout":"post","title":"COM Exception with IISNode and node-export-server","description":"Find out where these SetProcessDpiAwareness exception in node-export-server are coming from","date":"2018-11-29 12:46:00 +0100","slug":"com-exception-with-iisnode-and-node-export-server","content":"\n## The Problem\n\nFor our web application, we use Highcharts to render beautiful charts. Some charts are reused multiple times across the website, so we decided to prerender them via [highcharts/node-export-server](https://github.com/highcharts/node-export-server). Due to operational reasons, it is hosted inside a Windows Service via [Azure/iisnode](https://github.com/Azure/iisnode). This process works reasonably well. However, we noticed, that there are errors logged, although the charts seem to be rendered just fine:\n\n```\n[error] phantom worker 2 error - SetProcessDpiAwareness failed: \"COM error 0x80070005  (Unknown error 0x0ffffffff80070005)\"\n```\n\n## Investigation of the Error\n\nNaturally, we wanted to find the cause of this error, if there are some issues we should be aware of and if there is anything we could do to avoid it.\n\nA quick search reveals, that there are quite some GitHub repositories, that experience similar issues. In the end, most of them refer to an issue in PhantomJS. The most prominent discussion is in the [issue #14095](https://github.com/ariya/phantomjs/issues/14095). If you don't know: \"PhantomJS (phantomjs.org) is a headless WebKit scriptable with JavaScript.\" (from Phantom JS README). Incidentally, it is used by the Highcharts Node.js Export Server to render the charts. And unfortunately, this issue occurs, if PhantomJS is run from a service in Windows. Which happens to be just what we are doing.\n\n## Resolving the Error\n\n### Pass flag to PhantomJS\n\nHowever, there seems to be a way around this issue. According the issue, it is possible to pass `-platform windows:dpiawareness=0` to PhantomJS. So can we actually configure this, since the phantomjs process is spawned by the node-export-server? The actual call happens in `phantompool.js`:\n\n```js\n// https://github.com/highcharts/node-export-server/blob/2.0.16/lib/phantompool.js\nworker.process = phantomjs.exec(settings.worker, (__dirname + '/../'));\n```\n\nThere is no way to configure additional options, so we are out of luck here.\n\n### Windows Registry\n\nThere seems to be some additional way to work around this issue via the Windows Registry or Windows Policies, but I wasn't able to find out the specifics. If you have more luck on this front, please let me know.\n\n### Fork node-export-server\n\nAnother possibility would be to fork the node-export-server repository on GitHub and implement the desired functionality. However, this would cause additional overhead and it seems unlikely, that this would be merged back into the main repository. Since it seems that the engineers from Highcharts are thinking about moving to a different headless browser like Chrome (with its rather new headless mode). However, there doesn't seem to be a clear path or timeline yet. Follow the [issue #57 on GitHub](https://github.com/highcharts/node-export-server/issues/57) for further updates.\n\n## Result\n\nIn the end, we decided to live with these errors for now, as there doesn't seem to be any problem with the chart generation itself. Workarounds would require further development and testing resources which are currently not available.\n\n**Resources**\n* [node-export-server Repository](https://github.com/highcharts/node-export-server)\n* [iisnode Repository](https://github.com/Azure/iisnode)\n* [PhantomJS Repository](https://github.com/ariya/phantomjs)\n","url":"https://zlypher.github.io/posts/com-exception-with-iisnode-and-node-export-server"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"com-exception-with-iisnode-and-node-export-server"},"buildId":"_tmxQgfmILsdsozf-wc_b","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>